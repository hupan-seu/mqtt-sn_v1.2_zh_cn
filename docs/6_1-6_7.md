## 6. 功能描述
MQTT-SN的一个重要设计点是尽可能接近MQTT。因此，所有协议语义
应尽可能保持与MQTT定义的相同。  
在下文中，我们将重点关注那些相对于MQTT新增或修改的点。  

### 6.1 网关的广播和发现  
此过程是全新的，在MQTT中不存在。  

网关可以通过周期性地向所有连到网络中的设备，广播ADVERTISE消息来宣告其存在。网关应该仅通告它自己的存在（如果网关连接到服务器，或者它本身就是一个服务器）。  

多个网关可以在同一网络中同时处于活动状态。在这种情况下，他们会有不同的id，由客户端决定它想要连接哪个网关。但是在任何时候客户端都只允许连接到一个网关。  

客户端应维护活动的网关列表及其网络地址。这个列表通过收到的ADVERTISE消息和GWINFO消息填充和更新。  

网关发送下一个ADVERTISE消息的时间间隔(Tadv)，由ADVERTISE消息的Duration字段指示。客户端可以使用此信息来监视网关的可用性。
例如，如果它没有接收到来自网关的ADVERTISE消息连续Navd次数，它可以
假设网关已经关闭并将其从活动网关列表中删除。同样，处于备用状态的网关将变为活动状态（即开始发送ADVERTISE消息）如果它连续几次错过
来自某个网关的ADVERTISE消息，替代不可用的网关。  

由于ADVERTISE消息被广播到整个无线网络中，因此网关发送的两个ADVERTISE消息时间间隔Tadv
应该足够大（例如大于15分钟）以避免网络中的带宽拥塞。  

Tadv取值过大，将导致寻找网关的新客户端等待很长时间。为了缩短该等待时间，客户端可以广播SEARCHGW消息。为了防止几个客户端几乎同时开始搜索网关时产生的广播风暴，发送SEARCHGW消息应
延迟0到T searchgw 之间的随机时间。客户端如果在此延迟时间内收到另一个客户端发送的SEARCHGW消息，它将取消SEARCHGW的发送，并且表现得好像这个SEARCHGW消息是自己发送的。  

SEARCHGW消息的广播半径Rb是有限的，例如在密集部署情况下的单跳MQTT-SN客户端。  

收到SEARCHGW消息后，网关将回复包含自己id的GWINFO消息。同样的，如果客户端在其活动网关列表中至少有一个活动网关，它也会使用GWINFO消息进行应答。如果客户端在其列表中有多个网关，它则从其中选择一个网关并将该信息放在GWINFO消息应答。  

与SEARCHGW消息一样，GWINFO消息以相同的半径Rb广播，这个值
在SEARCHGW消息中获取。 当传输这两种消息时，广播半径Rb也被传递到底层传播。  

为了优先考虑网关，客户端将延迟一段随机时间T GWINFO发送GWINFO消息。如果在此延迟时间内客户端收到GWINFO消息，它将取消发送GWINFO消息。  

在没有响应的情况下，可以重传SEARCHGW消息。在这种情况下，两个连续的SEARCHGW消息的时间间隔应该以指数方式增加。  

### 6.2 客户端的连接设置 
与MQTT一样，MQTT-SN客户端需要先建立与GW的连接，然后才能与之交换信息
那个GW。建立与GW的连接的过程在图3中示出，其中假设为
客户端请求网关提示传输威尔主题和威尔消息。显示此请求
通过设置CONNECT消息的会标志。然后客户端将这两条信息发送给
GW收到相应的请求消息WILLTOPICREQ和WILLMSGREQ。程序，流程
终止于GW发送的CONNACK消息。
如果未设置会标志，则GW直接用CONNACK消息应答。
c Copyright IBM Corporation 1999,2013。保留所有权利。
20
第22页
图3：连接过程
如果GW无法接受连接请求（例如由于拥塞或不支持连接请求）
在CONNECT消息中指示的特征），GW返回具有拒绝原因的CONNACK消息。
6.3清洁会议 