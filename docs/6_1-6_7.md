## 6. 功能描述
MQTT-SN的一个重要设计点是尽可能接近MQTT。因此，所有协议语义
应尽可能保持与MQTT定义的相同。  
在下文中，我们将重点关注那些相对于MQTT新增或修改的点。  

### 6.1 网关的广播和发现  
此过程是全新的，在MQTT中不存在。  

网关可以通过周期性地向所有连到网络中的设备，广播ADVERTISE消息来宣告其存在。网关应该仅通告它自己的存在（如果网关连接到服务器，或者它本身就是一个服务器）。  

多个网关可以在同一网络中同时处于活动状态。在这种情况下，他们会有不同的id，由客户端决定它想要连接哪个网关。但是在任何时候客户端都只允许连接到一个网关。  

客户端应维护活动的网关列表及其网络地址。这个列表通过收到的ADVERTISE消息和GWINFO消息填充和更新。  

网关发送下一个ADVERTISE消息的时间间隔(Tadv)，由ADVERTISE消息的Duration字段指示。客户端可以使用此信息来监视网关的可用性。
例如，如果它没有接收到来自网关的ADVERTISE消息连续Navd次数，它可以
假设网关已经关闭并将其从活动网关列表中删除。同样，处于备用状态的网关将变为活动状态（即开始发送ADVERTISE消息）如果它连续几次错过
来自某个网关的ADVERTISE消息，替代不可用的网关。  

由于ADVERTISE消息被广播到整个无线网络中，因此网关发送的两个ADVERTISE消息时间间隔Tadv
应该足够大（例如大于15分钟）以避免网络中的带宽拥塞。  

Tadv取值过大，将导致寻找网关的新客户端等待很长时间。为了缩短该等待时间，客户端可以广播SEARCHGW消息。为了防止几个客户端几乎同时开始搜索网关时产生的广播风暴，发送SEARCHGW消息应
延迟0到T searchgw 之间的随机时间。客户端如果在此延迟时间内收到另一个客户端发送的SEARCHGW消息，它将取消SEARCHGW的发送，并且表现得好像这个SEARCHGW消息是自己发送的。  

SEARCHGW消息的广播半径Rb是有限的，例如在密集部署情况下的单跳MQTT-SN客户端。  

收到SEARCHGW消息后，网关将回复包含自己id的GWINFO消息。同样的，如果客户端在其活动网关列表中至少有一个活动网关，它也会使用GWINFO消息进行应答。如果客户端在其列表中有多个网关，它则从其中选择一个网关并将该信息放在GWINFO消息应答。  

与SEARCHGW消息一样，GWINFO消息以相同的半径Rb广播，这个值
在SEARCHGW消息中获取。 当传输这两种消息时，广播半径Rb也被传递到底层传播。  

为了优先考虑网关，客户端将延迟一段随机时间T GWINFO发送GWINFO消息。如果在此延迟时间内客户端收到GWINFO消息，它将取消发送GWINFO消息。  

在没有响应的情况下，可以重传SEARCHGW消息。在这种情况下，两个连续的SEARCHGW消息的时间间隔应该以指数方式增加。  

### 6.2 客户端的连接设置 
与MQTT一样，MQTT-SN客户端需要先与网关建立连接，然后才能与那个网关交换信息。与网关的建立连接的过程在图3中表示，其中假设客户端请求网关传输遗嘱主题和遗嘱消息。这种请求
通过设置CONNECT消息的Will标志来表示。然后客户端在收到网关相应的请求消息WILLTOPICREQ和WILLMSGREQ时，将这两条信息发送给网关。流程终止于网关发送的CONNACK消息。  

如果Will标志未设置，则网关直接用CONNACK消息应答。  

图3：连接过程  

如果网关无法接受连接请求（例如由于拥塞或不支持客户端在CONNECT消息中指示的特性），网关返回具有拒绝原因的CONNACK消息。  

### 6.3 清除会话
使用MQTT，当客户端断开连接时，不会删除其订阅。它们对于新的有效连接是持久的，直到客户端明确取消订阅，或客户端建立新连接设置“clean session”标志。  

在MQTT-SN中，“清除会话”的含义扩展到遗嘱功能，即不仅是订阅是持久性的，遗嘱主题和遗嘱消息也是。CONNECT消息中的两个标志“CleanSession”和“Will”具有以下含义：  
- CleanSession = true，Will = true：网关将删除所有与客户端相关的订阅和遗嘱数据， 并开始提示新的遗嘱主题和遗嘱消息。 
- CleanSession = true，Will = false：网关将删除所有与客户端相关的订阅和遗嘱数据，并返回CONNACK（不提示遗嘱主题和遗嘱消息）。
-  CleanSession = false，Will = true：网关保留所有存储的客户端数据，但提示输入新的遗嘱主题和遗嘱消息。新接收的遗嘱数据将覆盖存储的遗嘱数据。 
-  CleanSession = false，Will = false：网关保留所有存储的客户端数据并返回CONNACK（不提示遗嘱主题和遗嘱消息）。  

请注意，如果客户端想要在连接设置时仅删除遗嘱数据，则可以发送CONNECT消息时使用“CleanSession = false”和“Will = true”，并在收到提示时向网关发送空的WILLTOPIC消息来实现。它还可以发送带有“CleanSession = false”和“Will = false”的CONNECT消息，并使用第6.4节中删除或修改遗嘱数据的过程。  

### 6.4 更新遗嘱数据的过程

在连接期间的任何时候，客户端都可以通过发送WILLTOPICUPD或者WILLMSGUPD消息，来更新存储在网关中的遗嘱数据。 这两条消息中包含的信息将覆盖存储在网关中的相应数据。两个消息都由网关确认。两条消息都可以 彼此独立使用。  

请注意，空的WILLTOPICUPD消息将删除存储在其中的威尔主题和会消息 网关。 

### 6.5 主题名称注册过程

由于无线传感器网络中的带宽有限且消息有效载荷较小，因此不会像MQTT中那样，数据和主题名在一条发布消息中一起使用。为此引入了注册程序，允许客户端和网关可以在发布消息之前，通知对方短主题ID和主题名称的对应关系，然后使用短主题ID发布消息。  

为了注册主题名称，客户端向网关发送REGISTER消息。如果注册可以接受， 网关将主题Id分配给接收到的主题名称，并将REGACK消息返回给客户端。 如果注册无法接受，REGACK也会发送给客户端，并在“ReturnCode”字段中编码失败的原因。   

在收到带有ReturnCode =“accepted”的REGACK消息后，客户端将使用分配的主题Id发布相应主题名称的数据。但是，如果REGACK包含拒绝代码，客户可以尝试再次注册。如果返回代码为“拒绝：拥塞”，则客户端应等待时间Twait后，再重新启动注册过程。  

在任何时间点，客户端只能有一个未完成的REGISTER消息，即它必须等待一个REGACK消息后，才可以注册另一个主题名称。  

如果网关想要通知客户端，有关主题名称和分配的主题ID的对应关系，则网关会向客户端发送REGISTER消息。便于网关稍后向客户端发布相应主题名称的消息。 这种情况会发生在，例如，当客户端重新连接而未设置“CleanSession”标志时，或者客户端订阅的主题包含＃或+等通配符时。  

### 6.6 客户端的发布过程

在成功的注册一个主题名称到网关之后，客户端可以通过向网关发送PUBLISH消息，开始发布与这个注册主题相关的数据，PUBLISH消息中包含分配的主题ID。   

MQTT中定义的所有三个的QoS级别及其相应的消息流，在MQTT-SN中都支持。 唯一的 差异是在PUBLISH消息中使用主题ID而不是主题名称。   

无论请求的QoS级别如何，客户端都可以接收PUBACK消息，来查看对PUBLISH的接受情况，其中包含
- ReturnCode =“拒绝：无效主题ID”：在这种情况下，客户端需要再次注册主题名称，来发布与该主题名称相关的数据。  
- ReturnCode =“拒绝：拥塞”：客户端应停止向网关发布至少Twait时间。

在任何时间点，客户端可能只有一个未完成的QoS级别1或2的PUBLISH消息，即它必须 等待此PUBLISH消息交换的终止，然后才能启动新的1级或2级事务。 

### 6.7 预定义的主题ID和短主题名称

如6.5节所述，主题ID是对基于字符串的主题名称的两字节的长替换。一个客户端需要使用REGISTER过程来通知网关它想要使用的主题名称，并从网关获取到对应的主题的ID。然后在发送到网关的PUBLISH消息中使用此主题ID。在相反的方向上，网关PUBLISH消息也包含一个2字节的主题ID（而不是基于字符串的主题名称），客户端通过以下方式获取到主题ID和主题名称的对应关系，要么是前订阅过程，要么是网关启动的注册过程。   

“预定义”主题ID是这样的主题ID，它的主题名称映射，是客户端应用程序和网关都预先知道的。这在消息的Flags字段中指示。使用预定义主题ID时， 双方可以立即开始发送PUBLISH消息，不需要注册过程，就像“正常”主题ID一样。收到带有预定义主题ID的PUBLISH消息时， 如果其中主题名称的映射未知，接收方应返回带有ReturnCode = “拒绝：无效主题ID”的PUBACK消息。请注意，和正常主题ID的情况不同，此错误无法通过重新注册来解决。  

如果客户端想要接收某个预定义的主题ID的PUBLISH消息，它仍然需要订阅该主题ID。为了避免一个预定义主题ID和一个两字节的短主题名称之间产生混淆，订阅消息包含一个标志，指示它是订阅短主题名称还是预定义的主题ID。  

“短”主题名称是具有固定两个字节长度的主题名称。它可以和数据一起携带在PUBLISH消息中，因此短主题名称不需要注册过程。否则，全部适用于普通主题名称的规则也适用于短主题名称。但请注意，在订阅短主题名称时使用通配符是没有意义的 ，因为只有两个字符，无法定义有意义的名称层次结构。  
