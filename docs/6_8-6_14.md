### 6.8 发布的QoS级别-1 

此功能是为非常简单的、不支持除此任何其他功能的客户端定义的。 没有建立连接也没有断开，没有注册或订阅。客户端只是向网关（网关地址由客户端事先知道）发送它的PUBLISH消息并忘记它们。它并不关心网关地址是否正确，网关是否存活，或者消息是否到达网关。  

对于服务质量级别为-1的PUBLISH消息，仅允许以下参数值： 
- QoS的标志：设置为“0b11”。
- TopicIdType标志：预定义主题ID为“0B01”，短主题名称为“0b10”。
-  TopicId字段：预定义主题ID或短主题名称的值。
-   Data字段：要发布的数据。 

### 6.9 客户端主题的订阅/取消订阅过程

要订阅主题名称，客户端会向网关发送一条包含要订阅主题的SUBSCRIBE消息。如果网关接受订阅，则会为接收的主题名称分配主题ID，并将主题ID方在SUBACK消息中发给客户端。如果订阅无法接受，也发送SUBACK消息到客户端，拒绝原因在ReturnCode字段中编码。如果拒绝原因是“被拒绝：拥塞”，客户端应该等待Twait时间后，重新发送SUBSCRIBE消息到网关。  

如果客户端订阅包含通配符的主题名称，返回的SUBACK消息将包含主题id值0x0000。 当要发送匹配主题名称的第一个PUBLISH消息时， 客户端网关使用注册过程，将使用的主题ID值通知客户端，另见第6.10节。   

与客户端的PUBLISH过程类似，也可以为某些主题名称预定义主题ID。 短主题名称 也可以使用。在这两种情况下，客户端仍需要订阅这些预定义的主题ID或短主题名称。  

要取消订阅，客户端会向网关发送UNSUBSCRIBE消息，然后由网关应 UNSUBACK消息。   

对于注册过程，客户端同一时刻只能有一个订阅或一个UNSUBCRIBE事务。  

### 6.10 网关的发布过程

与6.6节中描述的客户端发布过程类似，网关发送的PUBLISH消息中，包含之前在SUBACK消息中返回给客户端的主题ID值。   

在发送PUBLISH消息之前，网关可以发送REGISTER消息，以通知客户端主题名称对应的主题ID值。这种情况发生在，例如，当客户端重新连接时没有清除会话时，或者使用通配符订阅主题名称时。收到REGISTER消息后，客户端回复REGACK消息。网关将等待收到REGACK消息后，再在向客户端发送PUBLISH消息。  

客户端可以发送REGACK消息拒绝REGISTER消息，在消息中指示拒绝原因。这也表示客户端取消订阅了REGISTER消息中指示的主题名称。请注意，取消订阅带通配符的主题名称只能使用第6.9节中描述的取消订阅过程来完成，而不是拒绝REGISTER消息，因为REGISTER消息永远不包含带有通配符主题名称 。  

如果客户端收到具有未知主题ID值的PUBLISH消息，则它将以带有ReturnCode =“已拒绝：无效主题ID”的PUBACK消息响应。这将触发网关删除或更正错误的主题ID分配。  

请注意，如果主题名称或数据太长而无法放入REGISTER或PUBLISH消息中，则网关以静默方式中止发布过程，即不向受影响的订阅者发送警告。  

### 6.11 保持连接和PING过程 

与MQTT一样，Keep Alive计时器的值在CONNECT消息中指示。 客户应该在每个Keep Alive时间段内发送PINGREQ消息，网关通过PINGRESP确认信息。  

类似地，客户端在收到来自它所连接的网关的PINGREQ消息时，应使用PINGRESP消息进行应答。否则，就意味着收到的PINGREQ消息被忽略了。  

客户端应使用此过程来监督它所连接的网关的活跃性。 如果即使在多次重传PINGREQ之后，客户端也没有从网关接收PINGRESP消息，它应该首先尝试连接到另一个网关，然后再尝试重新连接到此网关（另请参阅 第6.13节）。请注意，因为客户端的保持活动计时器彼此不同步，如果网关故障，几乎没有同时发送的CONNECT消息风暴的危险，所有受影响的客户端都会转向新的网关。  

### 6.12 客户端的断开过程

客户端向网关发送DISCONNECT消息以指示它将要关闭连接。在这之后，客户端如果想要重新与网关交换信息，它必须与网关建立新的连接。与MQTT类似，如果设置了CleanSession标志，发送DISCONNECT消息不会影响现有订阅和遗嘱消息。除非客户端明确的取消订阅，或者客户端删除或修改，或者客户端用CleanSession标志建立了新连接，否则它们是持久的。网关通过向客户端返回DISCONNECT消息来确认收到断开消息。  

客户端也可能在未请求的情况下，收到网关发送的DISCONNECT消息。这种情况发生在，例如，当网关由于错误，而无法识别接收到的消息所属的客户端时。客户端收到这样的DISCONNECT消息后，应通过发送CONNECT消息，尝试再次与网关建立连接。  

### 6.13 客户端的重传过程 

所有向网关“单播”的消息（即使用网关的单播地址发送而不是广播），对消息预期的网关回复，由重试计时器Ťretry和重试计数器Nretry来监督。该重试计时器由客户端的在发送消息时启动，在收到网关预期的回复时。如果计时器超时还未收到预期的网关回复，则客户端重新发送该消息。在Nretry次重传之后，客户端中止该过程，并假定它与网关的MQTT-SN连接已断开。然后它尝试一次重新连接到当前网关，连接失败的话，它应该尝试连接到另一个网关。  

### 6.14 对休眠客户端的支持 

休眠客户端是工作在尽可能节省电源（电池供电）设备上的客户端。 这些设备只要处于非活动状态时，都需要进入休眠模式，并且在有数据发送或接收时唤醒 。服务器或者网关需要知道这些客户端的休眠状态，并将缓冲发送给他们的消息，以便以后在他们醒来时发送。  

如图4所示，从服务器或网关的角度来看，客户端可以是以下状态之一：活动，休眠，清醒，连接断开或丢失。当服务器或网关接收客户端发送的CONNECT消息时，客户端处于活动状态，如6.2节所述。该状态由服务器或网关使用“保持活动”计时器监督，如第6.11节所述。如果服务器或网关没有收到客户端的任何消息，持续时间超过保持活动持续时间（在CONNECT消息中指示）时，网关将客户端视为丢失并激活该客户端的遗嘱功能。  
当服务器或网关收到没有duration字段的DISCONNECT消息时，客户端进入断开连接状态。 该状态不受服务器或网关的时间监督。  

如果客户端想要休眠，它会发送包含休眠持续时间的DISCONNECT消息。服务器或网关 发送DISCONNECT消息来对客户端确认，并认为客户端处于休眠状态， 另请参见图5。休眠状态由服务器或网关根据指示的休眠时间监控。 如果超过休眠时间后，服务器或网关没有收到来自客户端的任何消息，服务器或网关将认为该客户端丢失，并且与保活过程一样，激活遗嘱特性。在休眠状态期间，需要发送到客户端的所有消息都缓存在服务器或网关。  

当服务器或网关从客户端接收到PINGREQ消息时，停止休眠计时器。像CONNECT消息一样，此PINGREQ消息包含客户端ID。然后，所识别的客户端处于清醒状态。 如果服务器或网关缓存了该客户端的消息，它会将这些消息发送给客户端。向客户端的消息传输过程，由服务器或网关通过PINGRESP消息停止，也就是说，服务器或网关再次将客户端视为睡眠状态，并在发送PINGRESP消息后重新启动睡眠定时器。  

如果服务器或网关没有为客户端缓冲的任何消息，则立即使用一个 PINGRESP消息进行应答，将客户端返回到睡眠状态，并重新启动该客户端的睡眠定时器。  

在发送PINGREQ消息到服务器或网关之后，客户端使用6.13章节的“重传过程” 监督服务器或网关发送的消息的到达，即，客户端每收到一个PINGRESP以外的消息时，重启重试计时器，并在收到PINGRESP时停止计时器。如果计时器超时，客户端重传PINGREQ消息并重启定时器。为避免因过度重传PINGREQ消息导致的电池消耗（例如，如果它丢失了网关），客户端应有限的重传PINGREQ消息（例如通过重试计数器）并在达到限制但仍然没有收到PINGRESP消息时，返回休眠状态 。  

在睡眠或唤醒状态，客户端可以通过发送CONNECT消息返回到活动状态，或通过发送正常的DISCONNECT消息（即没有duration字段）到断开状态。客户端还可以通过发送具有duration的新值的DISCONNECT消息来修改其睡眠持续时间。  

请注意，只有在想要检查服务器或网关是否有缓冲的消息时，睡眠客户端才应进入唤醒状态 ，并尽快返回到睡眠状态而不发送任何消息到服务器或网关。否则，它应该通过向服务器或网关发送CONNECT消息返回到活动状态。  
